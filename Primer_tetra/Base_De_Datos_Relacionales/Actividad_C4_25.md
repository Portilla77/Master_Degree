CREATE DATABASE DATA_BANK;
GO

USE DATA_BANK;
GO

CREATE TABLE SUCURSALES (
    ID_SUCURSAL INT PRIMARY KEY,
    NOMBRE VARCHAR(100) NOT NULL,
    CIUDAD VARCHAR(50) NOT NULL,
    ACTIVOS DECIMAL(15,2) NOT NULL
);

CREATE TABLE CLIENTES (
    ID_CLIENTE INT PRIMARY KEY,
    NOMBRE VARCHAR(100) NOT NULL,
    CALLE VARCHAR(100) NOT NULL,
    CIUDAD VARCHAR(50) NOT NULL
);

CREATE TABLE EMPLEADOS (
    ID_EMPLEADO INT PRIMARY KEY,
    NOMBRE VARCHAR(100) NOT NULL,
    TELEFONO VARCHAR(15) NOT NULL,
    FECHA_CONTRATO DATE NOT NULL,
    ANTIGUEDAD INT NOT NULL,
    ID_JEFE INT NULL, -- Relación con el jefe del empleado
    FOREIGN KEY (ID_JEFE) REFERENCES EMPLEADOS(ID_EMPLEADO)
);

CREATE TABLE CLIENTE_BANQUERO (
    ID_CLIENTE INT NOT NULL,
    ID_EMPLEADO INT NOT NULL,
    PRIMARY KEY (ID_CLIENTE, ID_EMPLEADO),
    FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE),
    FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADOS(ID_EMPLEADO)
);

CREATE TABLE CUENTAS (
    NUMERO_CUENTA INT PRIMARY KEY,
    SALDO DECIMAL(15,2) NOT NULL,
    FECHA_ULTIMO_ACCESO DATE NOT NULL
);

CREATE TABLE TIPOS_CUENTA (
    ID_TIPO_CUENTA INT PRIMARY KEY,
    TIPO_CUENTA VARCHAR(50) NOT NULL, -- 'Ahorro' o 'Corriente'
    TASA_INTERES DECIMAL(5,2), -- Solo para cuentas de ahorro
    DESCUBIERTO DECIMAL(15,2) -- Solo para cuentas corrientes
);

CREATE TABLE CUENTA_TIPO (
    NUMERO_CUENTA INT NOT NULL,
    ID_TIPO_CUENTA INT NOT NULL,
    PRIMARY KEY (NUMERO_CUENTA, ID_TIPO_CUENTA),
    FOREIGN KEY (NUMERO_CUENTA) REFERENCES CUENTAS(NUMERO_CUENTA),
    FOREIGN KEY (ID_TIPO_CUENTA) REFERENCES TIPOS_CUENTA(ID_TIPO_CUENTA)
);

CREATE TABLE CUENTA_CLIENTE (
    NUMERO_CUENTA INT NOT NULL,
    ID_CLIENTE INT NOT NULL,
    FECHA_ACCESO DATE NOT NULL,
    PRIMARY KEY (NUMERO_CUENTA, ID_CLIENTE),
    FOREIGN KEY (NUMERO_CUENTA) REFERENCES CUENTAS(NUMERO_CUENTA),
    FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE)
);

CREATE TABLE PRESTAMOS (
    ID_PRESTAMO INT PRIMARY KEY,
    ID_SUCURSAL INT NOT NULL,
    IMPORTE DECIMAL(15,2) NOT NULL,
    FOREIGN KEY (ID_SUCURSAL) REFERENCES SUCURSALES(ID_SUCURSAL)
);

CREATE TABLE PRESTAMO_CLIENTE (
    ID_PRESTAMO INT NOT NULL,
    ID_CLIENTE INT NOT NULL,
    PRIMARY KEY (ID_PRESTAMO, ID_CLIENTE),
    FOREIGN KEY (ID_PRESTAMO) REFERENCES PRESTAMOS(ID_PRESTAMO),
    FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE)
);

CREATE TABLE PAGOS_PRESTAMO (
    ID_PAGO INT NOT NULL,
    ID_PRESTAMO INT NOT NULL,
    IMPORTE DECIMAL(15,2) NOT NULL,
    FECHA_PAGO DATE NOT NULL,
    PRIMARY KEY (ID_PAGO, ID_PRESTAMO),
    FOREIGN KEY (ID_PRESTAMO) REFERENCES PRESTAMOS(ID_PRESTAMO)
);

INSERT INTO SUCURSALES (ID_SUCURSAL, NOMBRE, CIUDAD, ACTIVOS)
VALUES 
(1, 'Sucursal Centro', 'Ciudad A', 15000000.00),
(2, 'Sucursal Norte', 'Ciudad B', 10000000.00);

INSERT INTO CLIENTES (ID_CLIENTE, NOMBRE, CALLE, CIUDAD)
VALUES 
(1, 'Juan Pérez', 'Calle Principal', 'Ciudad A'),
(2, 'María Gómez', 'Calle Secundaria', 'Ciudad B');

INSERT INTO EMPLEADOS (ID_EMPLEADO, NOMBRE, TELEFONO, FECHA_CONTRATO, ANTIGUEDAD, ID_JEFE)
VALUES 
(1, 'Carlos López', '555-1234', '2015-01-15', 9, NULL), -- Es jefe
(2, 'Ana Torres', '555-5678', '2018-05-10', 6, 1);

INSERT INTO CLIENTE_BANQUERO (ID_CLIENTE, ID_EMPLEADO)
VALUES 
(1, 1), 
(2, 2);

INSERT INTO CUENTAS (NUMERO_CUENTA, SALDO, FECHA_ULTIMO_ACCESO)
VALUES 
(101, 5000.00, '2023-11-15'),
(102, 10000.00, '2023-11-10');

INSERT INTO TIPOS_CUENTA (ID_TIPO_CUENTA, TIPO_CUENTA, TASA_INTERES, DESCUBIERTO)
VALUES 
(1, 'Ahorro', 1.50, NULL),
(2, 'Corriente', NULL, 5000.00);

INSERT INTO CUENTA_TIPO (NUMERO_CUENTA, ID_TIPO_CUENTA)
VALUES 
(101, 1), 
(102, 2);

INSERT INTO CUENTA_CLIENTE (NUMERO_CUENTA, ID_CLIENTE, FECHA_ACCESO)
VALUES 
(101, 1, '2023-11-15'),
(102, 2, '2023-11-10');

INSERT INTO PRESTAMOS (ID_PRESTAMO, ID_SUCURSAL, IMPORTE)
VALUES 
(1, 1, 200000.00),
(2, 2, 500000.00);

INSERT INTO PRESTAMO_CLIENTE (ID_PRESTAMO, ID_CLIENTE)
VALUES 
(1, 1), 
(2, 2);

INSERT INTO PAGOS_PRESTAMO (ID_PAGO, ID_PRESTAMO, IMPORTE, FECHA_PAGO)
VALUES 
(1, 1, 50000.00, '2023-11-01'),
(2, 2, 100000.00, '2023-11-05');


/*Querys realizadas para la actividad de clase*/
SELECT C.NOMBRE AS Cliente, CU.NUMERO_CUENTA, CU.SALDO
FROM CLIENTES C
JOIN CUENTA_CLIENTE CC ON C.ID_CLIENTE = CC.ID_CLIENTE
JOIN CUENTAS CU ON CC.NUMERO_CUENTA = CU.NUMERO_CUENTA;

SELECT E.NOMBRE AS Banquero, C.NOMBRE AS Cliente
FROM EMPLEADOS E
JOIN CLIENTE_BANQUERO CB ON E.ID_EMPLEADO = CB.ID_EMPLEADO
JOIN CLIENTES C ON CB.ID_CLIENTE = C.ID_CLIENTE;

SELECT PP.ID_PAGO, PP.IMPORTE AS Pago, P.ID_PRESTAMO, P.IMPORTE AS ImporteTotal
FROM PAGOS_PRESTAMO PP
JOIN PRESTAMOS P ON PP.ID_PRESTAMO = P.ID_PRESTAMO;